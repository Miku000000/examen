import { isPlatformServer } from '@angular/common';
import { ChangeDetectionStrategy, Component, effect, ElementRef, inject, Injector, input, PLATFORM_ID, Renderer2, runInInjectionContext, } from '@angular/core';
import { injectNgIconPostProcessor, injectNgIconPreProcessor, } from '../../providers/features/csp';
import { injectLogger } from '../../providers/features/logger';
import { injectNgIconConfig } from '../../providers/icon-config.provider';
import { injectNgIconLoader, injectNgIconLoaderCache, } from '../../providers/icon-loader.provider';
import { injectNgIcons } from '../../providers/icon.provider';
import { coerceLoaderResult } from '../../utils/async';
import { coerceCssPixelValue } from '../../utils/coercion';
import { toPropertyName } from '../../utils/format';
import * as i0 from "@angular/core";
export class NgIcon {
    constructor() {
        /** Access the global icon config */
        this.config = injectNgIconConfig();
        /** Access the icons */
        this.icons = injectNgIcons();
        /** Access the icon loader if defined */
        this.loader = injectNgIconLoader();
        /** Access the icon cache if defined */
        this.cache = injectNgIconLoaderCache();
        /** Access the pre-processor */
        this.preProcessor = injectNgIconPreProcessor();
        /** Access the post-processor */
        this.postProcessor = injectNgIconPostProcessor();
        /** Access the injector */
        this.injector = inject(Injector);
        /** Access the renderer */
        this.renderer = inject(Renderer2);
        /** Determine the platform we are rendering on */
        this.platform = inject(PLATFORM_ID);
        /** Access the element ref */
        this.elementRef = inject(ElementRef);
        /** Access the logger */
        this.logger = injectLogger();
        /** Define the name of the icon to display */
        this.name = input();
        /** Define the svg of the icon to display */
        this.svg = input();
        /** Define the size of the icon */
        this.size = input(this.config.size, { transform: coerceCssPixelValue });
        /** Define the stroke-width of the icon */
        this.strokeWidth = input(this.config.strokeWidth);
        /** Define the color of the icon */
        this.color = input(this.config.color);
        // update the icon anytime the name or svg changes
        effect(() => this.updateIcon());
    }
    ngOnDestroy() {
        this.svgElement = undefined;
    }
    async updateIcon() {
        const name = this.name();
        const svg = this.svg();
        // if the svg is defined, insert it into the template
        if (svg !== undefined) {
            this.setSvg(svg);
            return;
        }
        if (name === undefined) {
            return;
        }
        const propertyName = toPropertyName(name);
        for (const icons of [...this.icons].reverse()) {
            if (icons[propertyName]) {
                // insert the SVG into the template
                this.setSvg(icons[propertyName]);
                return;
            }
        }
        // if there is a loader defined, use it to load the icon
        if (this.loader) {
            const result = await this.requestIconFromLoader(name);
            // if the result is a string, insert the SVG into the template
            if (result !== null) {
                this.setSvg(result);
                return;
            }
        }
        // if there is no icon with this name warn the user as they probably forgot to import it
        this.logger.warn(`No icon named ${name} was found. You may need to import it using the withIcons function.`);
    }
    setSvg(svg) {
        // if we are on the server, simply innerHTML the svg as we don't have the
        // level of control over the DOM that we do on the client, in otherwords
        // the approach we take to insert the svg on the client will not work on the server
        if (isPlatformServer(this.platform)) {
            this.elementRef.nativeElement.innerHTML = svg;
            // mark this component as server side rendered
            this.elementRef.nativeElement.setAttribute('data-ng-icon-ssr', '');
            return;
        }
        // if this was previously server side rendered, we should check if the svg is the same
        // if it is, we don't need to do anything
        if (this.elementRef.nativeElement.hasAttribute('data-ng-icon-ssr')) {
            // if it is different, we need to remove the server side rendered flag
            this.elementRef.nativeElement.removeAttribute('data-ng-icon-ssr');
            // retrieve the svg element
            this.svgElement =
                this.elementRef.nativeElement.querySelector('svg') ??
                    undefined;
            if (this.elementRef.nativeElement.innerHTML === svg) {
                return;
            }
        }
        // remove the old element
        if (this.svgElement) {
            this.renderer.removeChild(this.elementRef.nativeElement, this.svgElement);
        }
        // if the svg is empty, don't insert anything
        if (svg === '') {
            return;
        }
        const template = this.renderer.createElement('template');
        this.renderer.setProperty(template, 'innerHTML', this.preProcessor(svg));
        this.svgElement = template.content.firstElementChild;
        this.postProcessor(this.svgElement);
        // insert the element into the dom
        this.renderer.appendChild(this.elementRef.nativeElement, this.svgElement);
    }
    /**
     * Request the icon from the loader.
     * @param name The name of the icon to load.
     * @returns The SVG content for a given icon name.
     */
    requestIconFromLoader(name) {
        return new Promise(resolve => {
            runInInjectionContext(this.injector, async () => {
                // if we have a cache, check if the icon is already loaded (i.e, it is a string)
                if (this.cache) {
                    const cachedResult = this.cache.get(name);
                    if (typeof cachedResult === 'string') {
                        resolve(cachedResult);
                        return;
                    }
                    // it may be a promise, so we need to await it
                    if (cachedResult instanceof Promise) {
                        const result = await cachedResult;
                        resolve(result);
                        return;
                    }
                }
                const promise = coerceLoaderResult(this.loader(name));
                // store the promise in the cache so if we get repeated calls (e.g. in a loop) before the loader has resolved
                // then don't call the loader function multiple times
                this.cache?.set(name, promise);
                // await the result of the promise
                const result = await promise;
                // if we have a cache, store the result
                this.cache?.set(name, result);
                resolve(result);
            });
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.0", ngImport: i0, type: NgIcon, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.1.0", version: "18.2.0", type: NgIcon, isStandalone: true, selector: "ng-icon", inputs: { name: { classPropertyName: "name", publicName: "name", isSignal: true, isRequired: false, transformFunction: null }, svg: { classPropertyName: "svg", publicName: "svg", isSignal: true, isRequired: false, transformFunction: null }, size: { classPropertyName: "size", publicName: "size", isSignal: true, isRequired: false, transformFunction: null }, strokeWidth: { classPropertyName: "strokeWidth", publicName: "strokeWidth", isSignal: true, isRequired: false, transformFunction: null }, color: { classPropertyName: "color", publicName: "color", isSignal: true, isRequired: false, transformFunction: null } }, host: { properties: { "style.--ng-icon__stroke-width": "strokeWidth()", "style.--ng-icon__size": "size()", "style.color": "color()" } }, ngImport: i0, template: '', isInline: true, styles: [":host{display:inline-block;width:var(--ng-icon__size, 1em);height:var(--ng-icon__size, 1em);line-height:initial;vertical-align:initial;overflow:hidden}:host ::ng-deep svg{width:inherit;height:inherit;vertical-align:inherit}\n"], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.0", ngImport: i0, type: NgIcon, decorators: [{
            type: Component,
            args: [{ selector: 'ng-icon', template: '', standalone: true, changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        '[style.--ng-icon__stroke-width]': 'strokeWidth()',
                        '[style.--ng-icon__size]': 'size()',
                        '[style.color]': 'color()',
                    }, styles: [":host{display:inline-block;width:var(--ng-icon__size, 1em);height:var(--ng-icon__size, 1em);line-height:initial;vertical-align:initial;overflow:hidden}:host ::ng-deep svg{width:inherit;height:inherit;vertical-align:inherit}\n"] }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9saWIvY29tcG9uZW50cy9pY29uL2ljb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULE1BQU0sRUFDTixVQUFVLEVBQ1YsTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLEVBRUwsV0FBVyxFQUNYLFNBQVMsRUFDVCxxQkFBcUIsR0FDdEIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUNMLHlCQUF5QixFQUN6Qix3QkFBd0IsR0FDekIsTUFBTSw4QkFBOEIsQ0FBQztBQUN0QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDL0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUNMLGtCQUFrQixFQUNsQix1QkFBdUIsR0FDeEIsTUFBTSxzQ0FBc0MsQ0FBQztBQUM5QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdkQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDOztBQWtCcEQsTUFBTSxPQUFPLE1BQU07SUFzRGpCO1FBckRBLG9DQUFvQztRQUNuQixXQUFNLEdBQUcsa0JBQWtCLEVBQUUsQ0FBQztRQUUvQyx1QkFBdUI7UUFDTixVQUFLLEdBQUcsYUFBYSxFQUFFLENBQUM7UUFFekMsd0NBQXdDO1FBQ3ZCLFdBQU0sR0FBRyxrQkFBa0IsRUFBRSxDQUFDO1FB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RDtnQkFDckQsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUUvQixrQ0FBa0M7Z0JBQ2xDLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDO2dCQUU3Qix1Q0FBdUM7Z0JBQ3ZDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFFOUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzhHQWhNVSxNQUFNO2tHQUFOLE1BQU0sc3pCQVZQLEVBQUU7OzJGQVVELE1BQU07a0JBWmxCLFNBQVM7K0JBQ0UsU0FBUyxZQUNULEVBQUUsY0FDQSxJQUFJLG1CQUVDLHVCQUF1QixDQUFDLE1BQU0sUUFDekM7d0JBQ0osaUNBQWlDLEVBQUUsZUFBZTt3QkFDbEQseUJBQXlCLEVBQUUsUUFBUTt3QkFDbkMsZUFBZSxFQUFFLFNBQVM7cUJBQzNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybVNlcnZlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBlZmZlY3QsXG4gIEVsZW1lbnRSZWYsXG4gIGluamVjdCxcbiAgSW5qZWN0b3IsXG4gIGlucHV0LFxuICBPbkRlc3Ryb3ksXG4gIFBMQVRGT1JNX0lELFxuICBSZW5kZXJlcjIsXG4gIHJ1bkluSW5qZWN0aW9uQ29udGV4dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgdHlwZSB7IEljb25OYW1lIH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9pY29uL2ljb24tbmFtZSc7XG5pbXBvcnQge1xuICBpbmplY3ROZ0ljb25Qb3N0UHJvY2Vzc29yLFxuICBpbmplY3ROZ0ljb25QcmVQcm9jZXNzb3IsXG59IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9mZWF0dXJlcy9jc3AnO1xuaW1wb3J0IHsgaW5qZWN0TG9nZ2VyIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL2ZlYXR1cmVzL2xvZ2dlcic7XG5pbXBvcnQgeyBpbmplY3ROZ0ljb25Db25maWcgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvaWNvbi1jb25maWcucHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgaW5qZWN0TmdJY29uTG9hZGVyLFxuICBpbmplY3ROZ0ljb25Mb2FkZXJDYWNoZSxcbn0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL2ljb24tbG9hZGVyLnByb3ZpZGVyJztcbmltcG9ydCB7IGluamVjdE5nSWNvbnMgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvaWNvbi5wcm92aWRlcic7XG5pbXBvcnQgeyBjb2VyY2VMb2FkZXJSZXN1bHQgfSBmcm9tICcuLi8uLi91dGlscy9hc3luYyc7XG5pbXBvcnQgeyBjb2VyY2VDc3NQaXhlbFZhbHVlIH0gZnJvbSAnLi4vLi4vdXRpbHMvY29lcmNpb24nO1xuaW1wb3J0IHsgdG9Qcm9wZXJ0eU5hbWUgfSBmcm9tICcuLi8uLi91dGlscy9mb3JtYXQnO1xuXG4vLyBUaGlzIGlzIGEgdHlwZXNjcmlwdCB0eXBlIHRvIHByZXZlbnQgaW5mZXJlbmNlIGZyb20gY29sbGFwc2luZyB0aGUgdW5pb24gdHlwZSB0byBhIHN0cmluZyB0byBpbXByb3ZlIHR5cGUgc2FmZXR5XG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10eXBlc1xuZXhwb3J0IHR5cGUgSWNvblR5cGUgPSBJY29uTmFtZSB8IChzdHJpbmcgJiB7fSk7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25nLWljb24nLFxuICB0ZW1wbGF0ZTogJycsXG4gIHN0YW5kYWxvbmU6IHRydWUsXG4gIHN0eWxlVXJsczogWycuL2ljb24uY29tcG9uZW50LnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIGhvc3Q6IHtcbiAgICAnW3N0eWxlLi0tbmctaWNvbl9fc3Ryb2tlLXdpZHRoXSc6ICdzdHJva2VXaWR0aCgpJyxcbiAgICAnW3N0eWxlLi0tbmctaWNvbl9fc2l6ZV0nOiAnc2l6ZSgpJyxcbiAgICAnW3N0eWxlLmNvbG9yXSc6ICdjb2xvcigpJyxcbiAgfSxcbn0pXG5leHBvcnQgY2xhc3MgTmdJY29uIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgLyoqIEFjY2VzcyB0aGUgZ2xvYmFsIGljb24gY29uZmlnICovXG4gIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnID0gaW5qZWN0TmdJY29uQ29uZmlnKCk7XG5cbiAgLyoqIEFjY2VzcyB0aGUgaWNvbnMgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBpY29ucyA9IGluamVjdE5nSWNvbnMoKTtcblxuICAvKiogQWNjZXNzIHRoZSBpY29uIGxvYWRlciBpZiBkZWZpbmVkICovXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9hZGVyID0gaW5qZWN0TmdJY29uTG9hZGVyKCk7XG5cbiAgLyoqIEFjY2VzcyB0aGUgaWNvbiBjYWNoZSBpZiBkZWZpbmVkICovXG4gIHByaXZhdGUgcmVhZG9ubHkgY2FjaGUgPSBpbmplY3ROZ0ljb25Mb2FkZXJDYWNoZSgpO1xuXG4gIC8qKiBBY2Nlc3MgdGhlIHByZS1wcm9jZXNzb3IgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwcmVQcm9jZXNzb3IgPSBpbmplY3ROZ0ljb25QcmVQcm9jZXNzb3IoKTtcblxuICAvKiogQWNjZXNzIHRoZSBwb3N0LXByb2Nlc3NvciAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHBvc3RQcm9jZXNzb3IgPSBpbmplY3ROZ0ljb25Qb3N0UHJvY2Vzc29yKCk7XG5cbiAgLyoqIEFjY2VzcyB0aGUgaW5qZWN0b3IgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XG5cbiAgLyoqIEFjY2VzcyB0aGUgcmVuZGVyZXIgKi9cbiAgcHJpdmF0ZSByZWFkb25seSByZW5kZXJlciA9IGluamVjdChSZW5kZXJlcjIpO1xuXG4gIC8qKiBEZXRlcm1pbmUgdGhlIHBsYXRmb3JtIHdlIGFyZSByZW5kZXJpbmcgb24gKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwbGF0Zm9ybSA9IGluamVjdChQTEFURk9STV9JRCk7XG5cbiAgLyoqIEFjY2VzcyB0aGUgZWxlbWVudCByZWYgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBlbGVtZW50UmVmID0gaW5qZWN0PEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+PihFbGVtZW50UmVmKTtcblxuICAvKiogQWNjZXNzIHRoZSBsb2dnZXIgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBpbmplY3RMb2dnZXIoKTtcblxuICAvKiogRGVmaW5lIHRoZSBuYW1lIG9mIHRoZSBpY29uIHRvIGRpc3BsYXkgKi9cbiAgcmVhZG9ubHkgbmFtZSA9IGlucHV0PEljb25UeXBlPigpO1xuXG4gIC8qKiBEZWZpbmUgdGhlIHN2ZyBvZiB0aGUgaWNvbiB0byBkaXNwbGF5ICovXG4gIHJlYWRvbmx5IHN2ZyA9IGlucHV0PHN0cmluZz4oKTtcblxuICAvKiogRGVmaW5lIHRoZSBzaXplIG9mIHRoZSBpY29uICovXG4gIHJlYWRvbmx5IHNpemUgPSBpbnB1dCh0aGlzLmNvbmZpZy5zaXplLCB7IHRyYW5zZm9ybTogY29lcmNlQ3NzUGl4ZWxWYWx1ZSB9KTtcblxuICAvKiogRGVmaW5lIHRoZSBzdHJva2Utd2lkdGggb2YgdGhlIGljb24gKi9cbiAgcmVhZG9ubHkgc3Ryb2tlV2lkdGggPSBpbnB1dDxzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQ+KFxuICAgIHRoaXMuY29uZmlnLnN0cm9rZVdpZHRoLFxuICApO1xuXG4gIC8qKiBEZWZpbmUgdGhlIGNvbG9yIG9mIHRoZSBpY29uICovXG4gIHJlYWRvbmx5IGNvbG9yID0gaW5wdXQodGhpcy5jb25maWcuY29sb3IpO1xuXG4gIC8qKiBTdG9yZSB0aGUgaW5zZXJ0ZWQgU1ZHICovXG4gIHByaXZhdGUgc3ZnRWxlbWVudD86IFNWR0VsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgLy8gdXBkYXRlIHRoZSBpY29uIGFueXRpbWUgdGhlIG5hbWUgb3Igc3ZnIGNoYW5nZXNcbiAgICBlZmZlY3QoKCkgPT4gdGhpcy51cGRhdGVJY29uKCkpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdmdFbGVtZW50ID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVJY29uKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG5hbWUgPSB0aGlzLm5hbWUoKTtcbiAgICBjb25zdCBzdmcgPSB0aGlzLnN2ZygpO1xuXG4gICAgLy8gaWYgdGhlIHN2ZyBpcyBkZWZpbmVkLCBpbnNlcnQgaXQgaW50byB0aGUgdGVtcGxhdGVcbiAgICBpZiAoc3ZnICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuc2V0U3ZnKHN2Zyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHRvUHJvcGVydHlOYW1lKG5hbWUpO1xuXG4gICAgZm9yIChjb25zdCBpY29ucyBvZiBbLi4udGhpcy5pY29uc10ucmV2ZXJzZSgpKSB7XG4gICAgICBpZiAoaWNvbnNbcHJvcGVydHlOYW1lXSkge1xuICAgICAgICAvLyBpbnNlcnQgdGhlIFNWRyBpbnRvIHRoZSB0ZW1wbGF0ZVxuICAgICAgICB0aGlzLnNldFN2ZyhpY29uc1twcm9wZXJ0eU5hbWVdKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmIHRoZXJlIGlzIGEgbG9hZGVyIGRlZmluZWQsIHVzZSBpdCB0byBsb2FkIHRoZSBpY29uXG4gICAgaWYgKHRoaXMubG9hZGVyKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnJlcXVlc3RJY29uRnJvbUxvYWRlcihuYW1lKTtcblxuICAgICAgLy8gaWYgdGhlIHJlc3VsdCBpcyBhIHN0cmluZywgaW5zZXJ0IHRoZSBTVkcgaW50byB0aGUgdGVtcGxhdGVcbiAgICAgIGlmIChyZXN1bHQgIT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5zZXRTdmcocmVzdWx0KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmIHRoZXJlIGlzIG5vIGljb24gd2l0aCB0aGlzIG5hbWUgd2FybiB0aGUgdXNlciBhcyB0aGV5IHByb2JhYmx5IGZvcmdvdCB0byBpbXBvcnQgaXRcbiAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgYE5vIGljb24gbmFtZWQgJHtuYW1lfSB3YXMgZm91bmQuIFlvdSBtYXkgbmVlZCB0byBpbXBvcnQgaXQgdXNpbmcgdGhlIHdpdGhJY29ucyBmdW5jdGlvbi5gLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNldFN2Zyhzdmc6IHN0cmluZyk6IHZvaWQge1xuICAgIC8vIGlmIHdlIGFyZSBvbiB0aGUgc2VydmVyLCBzaW1wbHkgaW5uZXJIVE1MIHRoZSBzdmcgYXMgd2UgZG9uJ3QgaGF2ZSB0aGVcbiAgICAvLyBsZXZlbCBvZiBjb250cm9sIG92ZXIgdGhlIERPTSB0aGF0IHdlIGRvIG9uIHRoZSBjbGllbnQsIGluIG90aGVyd29yZHNcbiAgICAvLyB0aGUgYXBwcm9hY2ggd2UgdGFrZSB0byBpbnNlcnQgdGhlIHN2ZyBvbiB0aGUgY2xpZW50IHdpbGwgbm90IHdvcmsgb24gdGhlIHNlcnZlclxuICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm0pKSB7XG4gICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5pbm5lckhUTUwgPSBzdmc7XG4gICAgICAvLyBtYXJrIHRoaXMgY29tcG9uZW50IGFzIHNlcnZlciBzaWRlIHJlbmRlcmVkXG4gICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtbmctaWNvbi1zc3InLCAnJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gaWYgdGhpcyB3YXMgcHJldmlvdXNseSBzZXJ2ZXIgc2lkZSByZW5kZXJlZCwgd2Ugc2hvdWxkIGNoZWNrIGlmIHRoZSBzdmcgaXMgdGhlIHNhbWVcbiAgICAvLyBpZiBpdCBpcywgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5oYXNBdHRyaWJ1dGUoJ2RhdGEtbmctaWNvbi1zc3InKSkge1xuICAgICAgLy8gaWYgaXQgaXMgZGlmZmVyZW50LCB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgc2VydmVyIHNpZGUgcmVuZGVyZWQgZmxhZ1xuICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdkYXRhLW5nLWljb24tc3NyJyk7XG5cbiAgICAgIC8vIHJldHJpZXZlIHRoZSBzdmcgZWxlbWVudFxuICAgICAgdGhpcy5zdmdFbGVtZW50ID1cbiAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcjxTVkdFbGVtZW50Pignc3ZnJykgPz9cbiAgICAgICAgdW5kZWZpbmVkO1xuXG4gICAgICBpZiAodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID09PSBzdmcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHJlbW92ZSB0aGUgb2xkIGVsZW1lbnRcbiAgICBpZiAodGhpcy5zdmdFbGVtZW50KSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCB0aGlzLnN2Z0VsZW1lbnQpO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSBzdmcgaXMgZW1wdHksIGRvbid0IGluc2VydCBhbnl0aGluZ1xuICAgIGlmIChzdmcgPT09ICcnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdGVtcGxhdGU6IEhUTUxUZW1wbGF0ZUVsZW1lbnQgPVxuICAgICAgdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGVtcGxhdGUsICdpbm5lckhUTUwnLCB0aGlzLnByZVByb2Nlc3NvcihzdmcpKTtcblxuICAgIHRoaXMuc3ZnRWxlbWVudCA9IHRlbXBsYXRlLmNvbnRlbnQuZmlyc3RFbGVtZW50Q2hpbGQgYXMgU1ZHRWxlbWVudDtcbiAgICB0aGlzLnBvc3RQcm9jZXNzb3IodGhpcy5zdmdFbGVtZW50KTtcblxuICAgIC8vIGluc2VydCB0aGUgZWxlbWVudCBpbnRvIHRoZSBkb21cbiAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCB0aGlzLnN2Z0VsZW1lbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlcXVlc3QgdGhlIGljb24gZnJvbSB0aGUgbG9hZGVyLlxuICAgKiBAcGFyYW0gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaWNvbiB0byBsb2FkLlxuICAgKiBAcmV0dXJucyBUaGUgU1ZHIGNvbnRlbnQgZm9yIGEgZ2l2ZW4gaWNvbiBuYW1lLlxuICAgKi9cbiAgcHJpdmF0ZSByZXF1ZXN0SWNvbkZyb21Mb2FkZXIobmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBydW5JbkluamVjdGlvbkNvbnRleHQodGhpcy5pbmplY3RvciwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBpZiB3ZSBoYXZlIGEgY2FjaGUsIGNoZWNrIGlmIHRoZSBpY29uIGlzIGFscmVhZHkgbG9hZGVkIChpLmUsIGl0IGlzIGEgc3RyaW5nKVxuICAgICAgICBpZiAodGhpcy5jYWNoZSkge1xuICAgICAgICAgIGNvbnN0IGNhY2hlZFJlc3VsdCA9IHRoaXMuY2FjaGUuZ2V0KG5hbWUpO1xuXG4gICAgICAgICAgaWYgKHR5cGVvZiBjYWNoZWRSZXN1bHQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXNvbHZlKGNhY2hlZFJlc3VsdCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gaXQgbWF5IGJlIGEgcHJvbWlzZSwgc28gd2UgbmVlZCB0byBhd2FpdCBpdFxuICAgICAgICAgIGlmIChjYWNoZWRSZXN1bHQgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYWNoZWRSZXN1bHQ7XG4gICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IGNvZXJjZUxvYWRlclJlc3VsdCh0aGlzLmxvYWRlciEobmFtZSkpO1xuXG4gICAgICAgIC8vIHN0b3JlIHRoZSBwcm9taXNlIGluIHRoZSBjYWNoZSBzbyBpZiB3ZSBnZXQgcmVwZWF0ZWQgY2FsbHMgKGUuZy4gaW4gYSBsb29wKSBiZWZvcmUgdGhlIGxvYWRlciBoYXMgcmVzb2x2ZWRcbiAgICAgICAgLy8gdGhlbiBkb24ndCBjYWxsIHRoZSBsb2FkZXIgZnVuY3Rpb24gbXVsdGlwbGUgdGltZXNcbiAgICAgICAgdGhpcy5jYWNoZT8uc2V0KG5hbWUsIHByb21pc2UpO1xuXG4gICAgICAgIC8vIGF3YWl0IHRoZSByZXN1bHQgb2YgdGhlIHByb21pc2VcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvbWlzZTtcblxuICAgICAgICAvLyBpZiB3ZSBoYXZlIGEgY2FjaGUsIHN0b3JlIHRoZSByZXN1bHRcbiAgICAgICAgdGhpcy5jYWNoZT8uc2V0KG5hbWUsIHJlc3VsdCk7XG5cbiAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==